"""
POI Service.
Generischer Service für verschiedene POI-Typen (Shops, Restaurants, Services).
"""

import logging
from typing import Optional

from pydantic import BaseModel

from services.cache import get_cache_service, CACHE_KEYS

logger = logging.getLogger(__name__)


class Location(BaseModel):
    """Standort."""
    latitude: float
    longitude: float


class ImageUrls(BaseModel):
    """Bild-URLs."""
    small: Optional[str] = None
    medium: Optional[str] = None


class POIInfo(BaseModel):
    """POI-Informationen."""
    id: int
    name: str
    description: Optional[str] = None
    type: str
    area_id: Optional[int] = None
    location: Optional[Location] = None
    image: Optional[ImageUrls] = None
    icon: Optional[str] = None


def extract_image_urls(image_data: Optional[dict]) -> Optional[ImageUrls]:
    """Extrahiert Bild-URLs aus den POI-Daten."""
    if not image_data:
        return None
    
    return ImageUrls(
        small=image_data.get("small"),
        medium=image_data.get("medium")
    )


async def get_pois_by_type(poi_type: str) -> list[POIInfo]:
    """
    Holt alle POIs eines bestimmten Typs (nur Europapark).
    """
    cache = get_cache_service()
    pois_data = await cache.load(CACHE_KEYS["pois"])
    
    if not pois_data or "data" not in pois_data:
        return []
    
    results = []
    for poi in pois_data["data"].get("pois", []):
        scopes = poi.get("scopes", [])
        
        # Nur Europapark und passender Typ
        if poi.get("type") != poi_type or "europapark" not in scopes:
            continue
        
        # Location
        location = None
        if poi.get("latitude") and poi.get("longitude"):
            location = Location(
                latitude=poi["latitude"],
                longitude=poi["longitude"]
            )
        
        results.append(POIInfo(
            id=poi["id"],
            name=poi.get("name", "Unbekannt"),
            description=poi.get("excerpt"),
            type=poi.get("type"),
            area_id=poi.get("areaId"),
            location=location,
            image=extract_image_urls(poi.get("image")),
            icon=poi.get("icon", {}).get("small") if poi.get("icon") else None
        ))
    
    return results


async def get_poi_by_id_and_type(poi_id: int, poi_type: str) -> Optional[POIInfo]:
    """
    Holt einen POI anhand von ID und Typ.
    """
    cache = get_cache_service()
    pois_data = await cache.load(CACHE_KEYS["pois"])
    
    if not pois_data or "data" not in pois_data:
        return None
    
    for poi in pois_data["data"].get("pois", []):
        scopes = poi.get("scopes", [])
        
        if (poi.get("id") == poi_id and 
            poi.get("type") == poi_type and 
            "europapark" in scopes):
            
            location = None
            if poi.get("latitude") and poi.get("longitude"):
                location = Location(
                    latitude=poi["latitude"],
                    longitude=poi["longitude"]
                )
            
            return POIInfo(
                id=poi["id"],
                name=poi.get("name", "Unbekannt"),
                description=poi.get("excerpt"),
                type=poi.get("type"),
                area_id=poi.get("areaId"),
                location=location,
                image=extract_image_urls(poi.get("image")),
                icon=poi.get("icon", {}).get("small") if poi.get("icon") else None
            )
    
    return None


# Convenience-Funktionen für spezifische Typen
async def get_all_shops() -> list[POIInfo]:
    return await get_pois_by_type("shopping")


async def get_shop_by_id(shop_id: int) -> Optional[POIInfo]:
    return await get_poi_by_id_and_type(shop_id, "shopping")


async def get_all_restaurants() -> list[POIInfo]:
    return await get_pois_by_type("gastronomy")


async def get_restaurant_by_id(restaurant_id: int) -> Optional[POIInfo]:
    return await get_poi_by_id_and_type(restaurant_id, "gastronomy")


async def get_all_services() -> list[POIInfo]:
    return await get_pois_by_type("service")


async def get_service_by_id(service_id: int) -> Optional[POIInfo]:
    return await get_poi_by_id_and_type(service_id, "service")
